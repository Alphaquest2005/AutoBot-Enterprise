// <autogenerated>
//   This file was generated by T4 code generator AllServices.tt.
//   Any changes made to this file manually will be lost next time the file is regenerated.
// </autogenerated>


using System;
using System.Collections.Generic;
using System.Collections.Concurrent;
using System.Data.Entity.Infrastructure;
using System.Data.Entity.Core;
using System.Data.SqlClient;
using System.Diagnostics;
using System.ServiceModel;
using System.Threading.Tasks;
//using System.Transactions;


using System.Linq.Dynamic;
using System.ComponentModel.Composition;
using CoreEntities.Business.Entities;
using Core.Common.Contracts;
using Core.Common.Business.Services;
using Core.Common.UI;

using System.Data.Entity;
using System.Linq;
using TrackableEntities;
using TrackableEntities.Common;
using TrackableEntities.EF6;
using WaterNut.Interfaces;

namespace CoreEntities.Business.Services
{
   [Export (typeof(IFileTypesService))]
   [Export(typeof(IBusinessService))]
   [PartCreationPolicy(CreationPolicy.NonShared)]
   [ServiceBehavior(InstanceContextMode = InstanceContextMode.PerCall,
                    ConcurrencyMode = ConcurrencyMode.Multiple)]
   
    public partial class FileTypesService : IFileTypesService, IDisposable
    {
        //private readonly CoreEntitiesContext dbContext;

        public bool StartTracking { get; set; }

        public FileTypesService()
        {
            try
            {
                // dbContext = new CoreEntitiesContext(){StartTracking = StartTracking};
                StartTracking = false;
             }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault, new FaultReason(fault.Message));
            }
        }

        public Task<IEnumerable<FileTypes>> GetFileTypes(List<string> includesLst = null, bool tracking = true)
        {
            try
            {
            //using (var scope = new TransactionScope(TransactionScopeOption.Required,
                                   //new TransactionOptions() {IsolationLevel = IsolationLevel.ReadUncommitted}))
               // {
                  using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                  {
				    var set = AddIncludes(includesLst, dbContext);
                    IEnumerable<FileTypes> entities = set.AsNoTracking().ToList();
                           //scope.Complete();
                            if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                            return Task.FromResult(entities);
                   }
                //}
             }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }


        public Task<FileTypes> GetFileTypesByKey(string Id, List<string> includesLst = null, bool tracking = true)
        {
            try
            {
			   if(string.IsNullOrEmpty(Id))return Task.FromResult<FileTypes>(null); 
              using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                var i = Convert.ToInt32(Id);
				var set = AddIncludes(includesLst, dbContext);
                FileTypes entity = set.AsNoTracking().SingleOrDefault(x => x.Id == i);
                if(tracking && entity != null) entity.StartTracking();
                return Task.FromResult(entity);
              }
             }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }


		 public Task<IEnumerable<FileTypes>> GetFileTypesByExpression(string exp, List<string> includesLst = null, bool tracking = true)
        {
            try
            {
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
					if (string.IsNullOrEmpty(exp) || exp == "None") return Task.FromResult<IEnumerable<FileTypes>>(new List<FileTypes>());
					var set = AddIncludes(includesLst, dbContext);
                    if (exp == "All")
                    {
						var entities = set.AsNoTracking().ToList();

                        if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                        return Task.FromResult<IEnumerable<FileTypes>>(entities); 
                    }
					else
					{
						var entities = set.AsNoTracking().Where(exp)
											.ToList();
                        if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                        return Task.FromResult<IEnumerable<FileTypes>>(entities); 
											
					}
					
                }
            }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }

		 public Task<IEnumerable<FileTypes>> GetFileTypesByExpressionLst(List<string> expLst, List<string> includesLst = null, bool tracking = true)
        {
            try
            {
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
					if (expLst.Count == 0 || expLst.FirstOrDefault() == "None") return Task.FromResult<IEnumerable<FileTypes>>(new List<FileTypes>());
					var set = AddIncludes(includesLst, dbContext);
                    if (expLst.FirstOrDefault() == "All")
                    {
						var entities = set.AsNoTracking().ToList(); 
                        if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                        return Task.FromResult<IEnumerable<FileTypes>>(entities); 
                    }
					else
					{
						set = AddWheres(expLst, set);
						var entities = set.AsNoTracking().ToList();
                        if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                        return Task.FromResult<IEnumerable<FileTypes>>(entities); 
											
					}
					
                }
            }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }

		public async Task<IEnumerable<FileTypes>> GetFileTypesByExpressionNav(string exp,
																							  Dictionary<string, string> navExp,
																							  List<string> includesLst = null, bool tracking = true)
        {
            try
            {
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
                    if (string.IsNullOrEmpty(exp) || exp == "None") return new List<FileTypes>();

                    if (exp == "All" && navExp.Count == 0)
                    {
                        var aentities = AddIncludes(includesLst, dbContext)
												.ToList();
                        if(tracking) aentities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                        return aentities; 
                    }
                    foreach (var itm in navExp)
                    {
                        switch (itm.Key)
                        {
                            case "ApplicationSettings":
                                return
                                    await
                                        GetWhere<ApplicationSettings>(dbContext, exp, itm.Value, "FileTypes", "SelectMany", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeMappings":
                                return
                                    await
                                        GetWhere<FileTypeMappings>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeActions":
                                return
                                    await
                                        GetWhere<FileTypeActions>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeContacts":
                                return
                                    await
                                        GetWhere<FileTypeContacts>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "AsycudaDocumentSet_Attachments":
                                return
                                    await
                                        GetWhere<AsycudaDocumentSet_Attachments>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileGroups":
                                return
                                    await
                                        GetWhere<FileGroups>(dbContext, exp, itm.Value, "FileTypes", "SelectMany", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "ChildFileTypes":
                                return
                                    await
                                        GetWhere<FileTypes>(dbContext, exp, itm.Value, "ChildFileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "ParentFileTypes":
                                return
                                    await
                                        GetWhere<FileTypes>(dbContext, exp, itm.Value, "ChildFileTypes", "SelectMany", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "EmailFileTypes":
                                return
                                    await
                                        GetWhere<EmailFileTypes>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "ImportActions":
                                return
                                    await
                                        GetWhere<ImportActions>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeReplaceRegex":
                                return
                                    await
                                        GetWhere<FileTypeReplaceRegex>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileImporterInfos":
                                return
                                    await
                                        GetWhere<FileImporterInfo>(dbContext, exp, itm.Value, "FileTypes", "SelectMany", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                            case "AsycudaDocumentSetAttachments":
                                return
                                    await
                                        GetWhere<AsycudaDocumentSetAttachments>(dbContext, exp, itm.Value, "FileTypes", "Select", includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);

                        }

                    }
					var set = AddIncludes(includesLst, dbContext);
                    var entities = set.AsNoTracking().Where(exp)
									.ToList();
                    if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                        return entities; 

                }
            }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }

        public Task<IEnumerable<FileTypes>> GetFileTypesByBatch(string exp,
                                                                int totalrow, List<string> includesLst = null, bool tracking = true)
        {
            try
            {

                var res = new ConcurrentQueue<List<FileTypes>>();



                if (string.IsNullOrEmpty(exp) || exp == "None") return Task.FromResult<IEnumerable<FileTypes>>(new List<FileTypes>());


                var batchSize = 500;
                var batches = Convert.ToInt32(totalrow / batchSize);

                if (totalrow % batchSize > 0) batches += 1;
                var exceptions = new ConcurrentQueue<Exception>();
                Parallel.For(0, batches,
                   new ParallelOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount * 2 },
                    bat =>
                    //  for (int bat = 0; bat < batches; bat++)
                    {
                        try
                        {
                            using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                            {
                                dbContext.Database.CommandTimeout = 0;
                                dbContext.Configuration.AutoDetectChangesEnabled = false;
                                //dbContext.Configuration.LazyLoadingEnabled = true;
                                var set = AddIncludes(includesLst, dbContext);
                                IQueryable<FileTypes> dset;
                                if (exp == "All")
                                {
                                    dset = set.OrderBy(x => x.Id);
                                }
                                else
                                {
                                    dset = set.OrderBy(x => x.Id).Where(exp);
                                }

                                var lst = dset.AsNoTracking()
                                    .Skip(bat * batchSize)
                                    .Take(batchSize)
                                    .ToList();
                                res.Enqueue(lst);
                            }

                        }
                        catch (Exception ex)
                        {
                            exceptions.Enqueue(ex);
                        }
                    }
                    );
                if (exceptions.Count > 0) throw new AggregateException(exceptions);
    
                var entities = res.SelectMany(x => x.ToList());
                if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                return Task.FromResult(entities); 

            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                var fault = new ValidationFault
                {
                    Result = false,
                    Message = updateEx.Message,
                    Description = updateEx.StackTrace
                };
                throw new FaultException<ValidationFault>(fault);
            }
        }
        public Task<IEnumerable<FileTypes>> GetFileTypesByBatchExpressionLst(List<string> expLst,
                                                                             int totalrow, List<string> includesLst = null, bool tracking = true)
        {
            try
            {

                var res = new ConcurrentQueue<List<FileTypes>>();



                if (expLst.Count == 0 || expLst.FirstOrDefault() == "None") return Task.FromResult<IEnumerable<FileTypes>>(new List<FileTypes>());


                var batchSize = 500;
                var batches = Convert.ToInt32(totalrow / batchSize);

                if (totalrow % batchSize > 0) batches += 1;
                var exceptions = new ConcurrentQueue<Exception>();
                Parallel.For(0, batches,
                   new ParallelOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount * 2 },
                    bat =>
                    //  for (int bat = 0; bat < batches; bat++)
                    {
                        try
                        {
                            using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                            {
                                dbContext.Database.CommandTimeout = 0;
                                dbContext.Configuration.AutoDetectChangesEnabled = false;
                                //dbContext.Configuration.LazyLoadingEnabled = true;
                                var set = AddIncludes(includesLst, dbContext);
                                IQueryable<FileTypes> dset;
                                if (expLst.FirstOrDefault() == "All")
                                {
                                    dset = set.OrderBy(x => x.Id);
                                }
                                else
                                {
                                    set = AddWheres(expLst, set);
                                    dset = set.OrderBy(x => x.Id);
                                }

                                var lst = dset.AsNoTracking()
                                    .Skip(bat * batchSize)
                                    .Take(batchSize)
                                    .ToList();
                                res.Enqueue(lst);
                            }

                        }
                        catch (Exception ex)
                        {
                            exceptions.Enqueue(ex);
                        }
                    }
                    );
                if (exceptions.Count > 0) throw new AggregateException(exceptions);
                var entities = res.SelectMany(x => x.ToList());
                if(tracking) entities.AsParallel(new ParallelLinqOptions() { MaxDegreeOfParallelism = Environment.ProcessorCount }).ForAll(x => x.StartTracking());
                return Task.FromResult(entities); 
            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                var fault = new ValidationFault
                {
                    Result = false,
                    Message = updateEx.Message,
                    Description = updateEx.StackTrace
                };
                throw new FaultException<ValidationFault>(fault);
            }
        }


        public Task<FileTypes> UpdateFileTypes(FileTypes entity)
        { 
            using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                try
                {   
                     var res = (FileTypes) entity;
                    if(res.TrackingState == TrackingState.Unchanged) res.TrackingState = TrackingState.Modified;                              
                    
                    dbContext.ApplyChanges(res);
                    dbContext.SaveChanges();
                    res.AcceptChanges();
                    return Task.FromResult(res);      
      
                }
                catch (DbUpdateConcurrencyException dce)
                {
                    // Get failed entry
                    foreach (var itm in dce.Entries)
                    {
                        if(itm.State != EntityState.Added)
                         {
                            var dv = itm.GetDatabaseValues();
                            if(dv != null) itm.OriginalValues.SetValues(dv);
                        }
                    }
                }
                catch (OptimisticConcurrencyException oce)
                {
                    var context = ((IObjectContextAdapter)dbContext).ObjectContext;

                    foreach (var entry in oce.StateEntries)
                    {
                        context.Refresh(System.Data.Entity.Core.Objects.RefreshMode.StoreWins, entry.Entity);
                    }
                }   
                catch (DbUpdateException e)
                {
                    
                   // Debugger.Break();
                    SqlException s = e.InnerException.InnerException as SqlException;
                    if (s != null && s.Number == 2627)
                    {
                         
                    }
                    else
                    {
                        Debugger.Break();
                        throw;
                    }
                }             
                catch (Exception updateEx)
                {
                    if (
                        updateEx.Message.Contains(
                            "The changes to the database were committed successfully, " +
                            "but an error occurred while updating the object context"))
                        return Task.FromResult(entity);

                    System.Diagnostics.Debugger.Break();
                    //throw new FaultException(updateEx.Message);
                        var fault = new ValidationFault
                                    {
                                        Result = false,
                                        Message = updateEx.Message,
                                        Description = updateEx.StackTrace
                                    };
                        throw new FaultException<ValidationFault>(fault);
                }
            }
           return Task.FromResult(entity);
        }

        public Task<FileTypes> CreateFileTypes(FileTypes entity)
        {
            try
            {
                var res = (FileTypes) entity;
              using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                dbContext.FileTypes.Add(res);
                dbContext.SaveChanges();
                res.AcceptChanges();
                return Task.FromResult(res);
              }
            }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }

        public Task<bool> DeleteFileTypes(string Id)
        {
            try
            {
              using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                var i = Convert.ToInt32(Id);
                FileTypes entity = dbContext.FileTypes
													.SingleOrDefault(x => x.Id == i);
                if (entity == null)
                    return Task.FromResult(false);

                    dbContext.FileTypes.Attach(entity);
                    dbContext.FileTypes.Remove(entity);
                    dbContext.SaveChanges();
                    return Task.FromResult(true);
              }
            }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }

        public async Task<bool> RemoveSelectedFileTypes(IEnumerable<string> lst)
        {
            try
            {
                StatusModel.StartStatusUpdate("Removing FileTypes", lst.Count());
                var t = Task.Run(() =>
                {
                    using (var ctx = new FileTypesService())
                    {
                        foreach (var item in lst.ToList())
                        {

                            ctx.DeleteFileTypes(item).Wait();
                            StatusModel.StatusUpdate();
                        }
                    }
                });
                await t.ConfigureAwait(false);
                return true;
            }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
            

               
        }

		// Virtural list Implementation

         public Task<int> CountByExpressionLst(List<string> expLst)
        {
            try
            {
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
                    if (expLst.Count == 0 || expLst.FirstOrDefault() == "None") return Task.FromResult(0);
                    var set = (IQueryable<FileTypes>)dbContext.FileTypes; 
                    if (expLst.FirstOrDefault() == "All")
                    {
                        return Task.FromResult(set.AsNoTracking().Count());
                    }
                    else
                    {
                        set = AddWheres(expLst, set);
                        return Task.FromResult(set.AsNoTracking().Count());
                    }
                    
                }
            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                var fault = new ValidationFault
                {
                    Result = false,
                    Message = updateEx.Message,
                    Description = updateEx.StackTrace
                };
                throw new FaultException<ValidationFault>(fault);
            }
        }

		public Task<int> Count(string exp)
        {
            try
            {
                using (CoreEntitiesContext dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    if (string.IsNullOrEmpty(exp) || exp == "None") return Task.FromResult(0);
                    if (exp == "All")
                    {
                        return Task.FromResult(dbContext.FileTypes
                            .AsNoTracking()
                            .Count());
                    }
                    else
                    {
                        
                        return Task.FromResult(dbContext.FileTypes
                            .AsNoTracking()
                            .Where(exp)
                            .Count());
                    }
                }
            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }
        
        public Task<IEnumerable<FileTypes>> LoadRange(int startIndex, int count, string exp)
        {
            try
            {
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
                    if (string.IsNullOrEmpty(exp) || exp == "None") return Task.FromResult<IEnumerable<FileTypes>>(new List<FileTypes>());
                    if (exp == "All")
                    {
                        return Task.FromResult<IEnumerable<FileTypes>>(dbContext.FileTypes
                            .AsNoTracking()
                            .OrderBy(y => y.Id)
                            .Skip(startIndex)
                            .Take(count)
                            .ToList());
                    }
                    else
                    {
                        
                        return Task.FromResult<IEnumerable<FileTypes>>(dbContext.FileTypes
                            .AsNoTracking()
                            .Where(exp)
                            .OrderBy(y => y.Id)
                            .Skip(startIndex)
                            .Take(count)
                            .ToList());
                    }
                }
            }
            catch (Exception updateEx)
            {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }

		public async Task<int> CountNav(string exp, Dictionary<string, string> navExp)
        {
            try
            {
                if (string.IsNullOrEmpty(exp) || exp == "None") return 0;
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
                    if (exp == "All" && navExp.Count == 0)
                    {
                        return dbContext.FileTypes
										.AsNoTracking()
                                        .Count();
                    }
                    foreach (var itm in navExp)
                    {
                        switch (itm.Key)
                        {
                            case "ApplicationSettings":
                                return await CountWhere<ApplicationSettings>(dbContext, exp, itm.Value, "FileTypes", "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeMappings":
                                return await CountWhere<FileTypeMappings>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeActions":
                                return await CountWhere<FileTypeActions>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeContacts":
                                return await CountWhere<FileTypeContacts>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "AsycudaDocumentSet_Attachments":
                                return await CountWhere<AsycudaDocumentSet_Attachments>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileGroups":
                                return await CountWhere<FileGroups>(dbContext, exp, itm.Value, "FileTypes", "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "ChildFileTypes":
                                return await CountWhere<FileTypes>(dbContext, exp, itm.Value, "ChildFileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "ParentFileTypes":
                                return await CountWhere<FileTypes>(dbContext, exp, itm.Value, "ChildFileTypes", "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "EmailFileTypes":
                                return await CountWhere<EmailFileTypes>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "ImportActions":
                                return await CountWhere<ImportActions>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeReplaceRegex":
                                return await CountWhere<FileTypeReplaceRegex>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileImporterInfos":
                                return await CountWhere<FileImporterInfo>(dbContext, exp, itm.Value, "FileTypes", "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "AsycudaDocumentSetAttachments":
                                return await CountWhere<AsycudaDocumentSetAttachments>(dbContext, exp, itm.Value, "FileTypes", "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
						}
                    }
                    return dbContext.FileTypes.Where(exp == "All" || exp == null ? "Id != null" : exp)
											.AsNoTracking()
                                            .Count();
                }
                
            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                var fault = new ValidationFault
                {
                    Result = false,
                    Message = updateEx.Message,
                    Description = updateEx.StackTrace
                };
                throw new FaultException<ValidationFault>(fault);
            }
        }

		private static async Task<int> CountWhere<T>(CoreEntitiesContext dbContext, string exp, string navExp, string navProp, string rel) where T : class
        {
              switch (rel)
		    {
		        case "SelectMany":
                    return await CountWhereSelectMany<T>(dbContext, exp, navExp, navProp)
									.ConfigureAwait(continueOnCapturedContext: false);
		            
                default:
                    return await CountWhereSelect<T>(dbContext, exp, navExp, navProp)
									.ConfigureAwait(continueOnCapturedContext: false);
		    }
        }

		private static Task<int> CountWhereSelectMany<T>(CoreEntitiesContext dbContext, string exp, string navExp, string navProp) where T : class
        {
			try
			{
            return Task.FromResult(dbContext.Set<T>()
                .AsNoTracking()
                .Where(navExp)
                .SelectMany(navProp).OfType<FileTypes>()
                .Where(exp == "All" || exp == null ? "Id != null" : exp)
                .Distinct()
                .OrderBy("Id")
                .Count());
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

		private static Task<int> CountWhereSelect<T>(CoreEntitiesContext dbContext, string exp, string navExp, string navProp) where T : class
        {
			try
			{
            return Task.FromResult(dbContext.Set<T>()
                .AsNoTracking()
                .Where(navExp)
                .Select(navProp).OfType<FileTypes>()
                .Where(exp == "All" || exp == null ? "Id != null" : exp)
                .Distinct()
                .OrderBy("Id")
                .Count());
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

		  public async Task<IEnumerable<FileTypes>> LoadRangeNav(int startIndex, int count, string exp,
                                                                                 Dictionary<string, string> navExp, IEnumerable<string> includeLst = null)
        {
            try
            {
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
                    if ((string.IsNullOrEmpty(exp) && navExp.Count == 0) || exp == "None") return new List<FileTypes>();
                    var set = AddIncludes(includeLst, dbContext);

                    if (exp == "All" && navExp.Count == 0)
                    {
                       
                        return set
									.AsNoTracking()
                                    .OrderBy(y => y.Id)
 
                                    .Skip(startIndex)
                                    .Take(count)
									.ToList();
                    }
                    foreach (var itm in navExp)
                    {
                        switch (itm.Key)
                        {
                            case "ApplicationSettings":
                                return
                                    await
                                        LoadRangeWhere<ApplicationSettings>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "SelectMany")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeMappings":
                                return
                                    await
                                        LoadRangeWhere<FileTypeMappings>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeActions":
                                return
                                    await
                                        LoadRangeWhere<FileTypeActions>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeContacts":
                                return
                                    await
                                        LoadRangeWhere<FileTypeContacts>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "AsycudaDocumentSet_Attachments":
                                return
                                    await
                                        LoadRangeWhere<AsycudaDocumentSet_Attachments>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileGroups":
                                return
                                    await
                                        LoadRangeWhere<FileGroups>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "SelectMany")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "ChildFileTypes":
                                return
                                    await
                                        LoadRangeWhere<FileTypes>(startIndex, count, dbContext, exp, itm.Value, "ChildFileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "ParentFileTypes":
                                return
                                    await
                                        LoadRangeWhere<FileTypes>(startIndex, count, dbContext, exp, itm.Value, "ChildFileTypes", "SelectMany")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "EmailFileTypes":
                                return
                                    await
                                        LoadRangeWhere<EmailFileTypes>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "ImportActions":
                                return
                                    await
                                        LoadRangeWhere<ImportActions>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileTypeReplaceRegex":
                                return
                                    await
                                        LoadRangeWhere<FileTypeReplaceRegex>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "FileImporterInfos":
                                return
                                    await
                                        LoadRangeWhere<FileImporterInfo>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "SelectMany")
													.ConfigureAwait(continueOnCapturedContext: false);

                            case "AsycudaDocumentSetAttachments":
                                return
                                    await
                                        LoadRangeWhere<AsycudaDocumentSetAttachments>(startIndex, count, dbContext, exp, itm.Value, "FileTypes", "Select")
													.ConfigureAwait(continueOnCapturedContext: false);

                          
							default:
                                throw new ArgumentException("No Navigation property found for " + itm.Key);
						}

                    }
                    return set//dbContext.FileTypes
								.AsNoTracking()
                                .Where(exp == "All" || exp == null ? "Id != null" : exp)
								.OrderBy(y => y.Id)
 
                                .Skip(startIndex)
                                .Take(count)
								.ToList();


                }
            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }

		private static async Task<IEnumerable<FileTypes>> LoadRangeWhere<T>(int startIndex, int count,
            CoreEntitiesContext dbContext, string exp, string navExp, string navProp, string rel, IEnumerable<string> includeLst = null) where T : class
        {
             switch (rel)
		    {
		        case "SelectMany":
                    return await LoadRangeSelectMany<T>(startIndex, count, dbContext, exp, navExp, navProp, includeLst)
									.ConfigureAwait(continueOnCapturedContext: false);
		            
                default:
                    return await LoadRangeSelect<T>(startIndex, count, dbContext, exp, navExp, navProp, includeLst)
									.ConfigureAwait(continueOnCapturedContext: false);
		    }
        }

		private static Task<IEnumerable<FileTypes>> LoadRangeSelectMany<T>(int startIndex, int count,
                                                                           CoreEntitiesContext dbContext, string exp, string navExp, string navProp, IEnumerable<string> includeLst = null) where T : class
        {
			try
			{
            var set = dbContext.Set<T>()
				.AsNoTracking()
                .Where(navExp)
                .SelectMany(navProp).OfType<FileTypes>();
    
            if (includeLst != null) set = includeLst.Aggregate(set, (current, itm) => current.Include(itm));            

            return Task.FromResult<IEnumerable<FileTypes>>(set
                .Where(exp == "All" || exp == null ? "Id != null" : exp)
                .Distinct()
                .OrderBy(y => y.Id)
 
                .Skip(startIndex)
                .Take(count)
                .ToList());
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

		private static Task<IEnumerable<FileTypes>> LoadRangeSelect<T>(int startIndex, int count,
                                                                       CoreEntitiesContext dbContext, string exp, string navExp, string navProp, IEnumerable<string> includeLst = null) where T : class
        {
			try
			{
              var set = dbContext.Set<T>()
				.AsNoTracking()
                .Where(navExp)
                .Select(navProp).OfType<FileTypes>();

               if (includeLst != null) set = includeLst.Aggregate(set, (current, itm) => current.Include(itm)); 
                
               return Task.FromResult<IEnumerable<FileTypes>>(set
                   .Where(exp == "All" || exp == null ? "Id != null" : exp)
                   .Distinct()
                   .OrderBy(y => y.Id)
 
                   .Skip(startIndex)
                   .Take(count)
                   .ToList());
							 }
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

        private static async Task<IEnumerable<FileTypes>> GetWhere<T>(CoreEntitiesContext dbContext,
            string exp, string navExp, string navProp, string rel, List<string> includesLst = null) where T : class
        {
			try
			{
			    switch (rel)
				{
					case "SelectMany":
						return await GetWhereSelectMany<T>(dbContext, exp, navExp, navProp, includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);
						
					default:
						return await GetWhereSelect<T>(dbContext, exp, navExp, navProp, includesLst)
										.ConfigureAwait(continueOnCapturedContext: false);
				}
			
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

		private static Task<IEnumerable<FileTypes>> GetWhereSelectMany<T>(CoreEntitiesContext dbContext,
                                                                          string exp, string navExp, string navProp, List<string> includesLst = null) where T : class
        {
			try
			{

			if (includesLst == null)
			{
				return Task.FromResult<IEnumerable<FileTypes>>(dbContext.Set<T>()
                    .AsNoTracking()
                    .Where(navExp)
                    .SelectMany(navProp).OfType<FileTypes>()
                    .Where(exp == "All" || exp == null?"Id != null":exp)
                    .Distinct()
                    .ToList());
			}

			var set = (DbQuery<FileTypes>)dbContext.Set<T>()
				.AsNoTracking()
                .Where(navExp)
                .SelectMany(navProp).OfType<FileTypes>()
                .Where(exp == "All" || exp == null?"Id != null":exp)
                .Distinct();

			set = includesLst.Aggregate(set, (current, itm) => current.Include(itm));

            return Task.FromResult<IEnumerable<FileTypes>>(set.ToList());
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

		private static Task<IEnumerable<FileTypes>> GetWhereSelect<T>(CoreEntitiesContext dbContext,
                                                                      string exp, string navExp, string navProp, List<string> includesLst = null) where T : class
        {
			try
			{

			if (includesLst == null)
			{
				return Task.FromResult<IEnumerable<FileTypes>>(dbContext.Set<T>()
                    .AsNoTracking()
                    .Where(navExp)
                    .Select(navProp).OfType<FileTypes>()
                    .Where(exp == "All" || exp == null?"Id != null":exp)
                    .Distinct()
                    .ToList());
			}

			var set = (DbQuery<FileTypes>)dbContext.Set<T>()
				.AsNoTracking()
                .Where(navExp)
                .Select(navProp).OfType<FileTypes>()
                .Where(exp == "All" || exp == null?"Id != null":exp)
                .Distinct();

			set = includesLst.Aggregate(set, (current, itm) => current.Include(itm));

            return Task.FromResult<IEnumerable<FileTypes>>(set.ToList());
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

			        public Task<IEnumerable<FileTypes>> GetFileTypesByApplicationSettingsId(string ApplicationSettingsId, List<string> includesLst = null)
        {
            try
            {
                using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                var i = Convert.ToInt32(ApplicationSettingsId);
                var set = AddIncludes(includesLst, dbContext);
                IEnumerable<FileTypes> entities = set//dbContext.FileTypes
                                                    // .Include(x => x.FileTypeMappings)									  
                                                    // .Include(x => x.FileTypeActions)									  
                                                    // .Include(x => x.FileTypeContacts)									  
                                                    // .Include(x => x.AsycudaDocumentSet_Attachments)									  
                                                    // .Include(x => x.ChildFileTypes)									  
                                                    // .Include(x => x.EmailFileTypes)									  
                                                    // .Include(x => x.ImportActions)									  
                                                    // .Include(x => x.FileTypeReplaceRegex)									  
                                                    // .Include(x => x.AsycudaDocumentSetAttachments)									  
                                      .AsNoTracking()
                                        .Where(x => x.ApplicationSettingsId.ToString() == ApplicationSettingsId.ToString())
										.ToList();
                return Task.FromResult(entities);
              }
             }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }
 	        public Task<IEnumerable<FileTypes>> GetFileTypesByFileGroupId(string FileGroupId, List<string> includesLst = null)
        {
            try
            {
                using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                var i = Convert.ToInt32(FileGroupId);
                var set = AddIncludes(includesLst, dbContext);
                IEnumerable<FileTypes> entities = set//dbContext.FileTypes
                                                    // .Include(x => x.FileTypeMappings)									  
                                                    // .Include(x => x.FileTypeActions)									  
                                                    // .Include(x => x.FileTypeContacts)									  
                                                    // .Include(x => x.AsycudaDocumentSet_Attachments)									  
                                                    // .Include(x => x.ChildFileTypes)									  
                                                    // .Include(x => x.EmailFileTypes)									  
                                                    // .Include(x => x.ImportActions)									  
                                                    // .Include(x => x.FileTypeReplaceRegex)									  
                                                    // .Include(x => x.AsycudaDocumentSetAttachments)									  
                                      .AsNoTracking()
                                        .Where(x => x.FileGroupId.ToString() == FileGroupId.ToString())
										.ToList();
                return Task.FromResult(entities);
              }
             }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }
 	        public Task<IEnumerable<FileTypes>> GetFileTypesByParentFileTypeId(string ParentFileTypeId, List<string> includesLst = null)
        {
            try
            {
                using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                var i = Convert.ToInt32(ParentFileTypeId);
                var set = AddIncludes(includesLst, dbContext);
                IEnumerable<FileTypes> entities = set//dbContext.FileTypes
                                                    // .Include(x => x.FileTypeMappings)									  
                                                    // .Include(x => x.FileTypeActions)									  
                                                    // .Include(x => x.FileTypeContacts)									  
                                                    // .Include(x => x.AsycudaDocumentSet_Attachments)									  
                                                    // .Include(x => x.ChildFileTypes)									  
                                                    // .Include(x => x.EmailFileTypes)									  
                                                    // .Include(x => x.ImportActions)									  
                                                    // .Include(x => x.FileTypeReplaceRegex)									  
                                                    // .Include(x => x.AsycudaDocumentSetAttachments)									  
                                      .AsNoTracking()
                                        .Where(x => x.ParentFileTypeId.ToString() == ParentFileTypeId.ToString())
										.ToList();
                return Task.FromResult(entities);
              }
             }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }
 	        public Task<IEnumerable<FileTypes>> GetFileTypesByOldFileTypeId(string OldFileTypeId, List<string> includesLst = null)
        {
            try
            {
                using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                var i = Convert.ToInt32(OldFileTypeId);
                var set = AddIncludes(includesLst, dbContext);
                IEnumerable<FileTypes> entities = set//dbContext.FileTypes
                                                    // .Include(x => x.FileTypeMappings)									  
                                                    // .Include(x => x.FileTypeActions)									  
                                                    // .Include(x => x.FileTypeContacts)									  
                                                    // .Include(x => x.AsycudaDocumentSet_Attachments)									  
                                                    // .Include(x => x.ChildFileTypes)									  
                                                    // .Include(x => x.EmailFileTypes)									  
                                                    // .Include(x => x.ImportActions)									  
                                                    // .Include(x => x.FileTypeReplaceRegex)									  
                                                    // .Include(x => x.AsycudaDocumentSetAttachments)									  
                                      .AsNoTracking()
                                        .Where(x => x.OldFileTypeId.ToString() == OldFileTypeId.ToString())
										.ToList();
                return Task.FromResult(entities);
              }
             }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }
 	        public Task<IEnumerable<FileTypes>> GetFileTypesByFileInfoId(string FileInfoId, List<string> includesLst = null)
        {
            try
            {
                using ( var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
              {
                var i = Convert.ToInt32(FileInfoId);
                var set = AddIncludes(includesLst, dbContext);
                IEnumerable<FileTypes> entities = set//dbContext.FileTypes
                                                    // .Include(x => x.FileTypeMappings)									  
                                                    // .Include(x => x.FileTypeActions)									  
                                                    // .Include(x => x.FileTypeContacts)									  
                                                    // .Include(x => x.AsycudaDocumentSet_Attachments)									  
                                                    // .Include(x => x.ChildFileTypes)									  
                                                    // .Include(x => x.EmailFileTypes)									  
                                                    // .Include(x => x.ImportActions)									  
                                                    // .Include(x => x.FileTypeReplaceRegex)									  
                                                    // .Include(x => x.AsycudaDocumentSetAttachments)									  
                                      .AsNoTracking()
                                        .Where(x => x.FileInfoId.ToString() == FileInfoId.ToString())
										.ToList();
                return Task.FromResult(entities);
              }
             }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }
        }
 
		public decimal SumField(string whereExp, string field)
         {
             try
             {
                 using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                 {
                    dbContext.Database.CommandTimeout = 0;
					decimal res = 0;
                     if (string.IsNullOrEmpty(whereExp) || whereExp == "None") return 0;
                     if (whereExp == "All")
                     {
                          res = Convert.ToDecimal(dbContext.FileTypes.AsNoTracking().Sum(field));
                     }
                     else
                     {
                         res = Convert.ToDecimal(dbContext.FileTypes.AsNoTracking().Where(whereExp).Sum(field));
                     }
                     
                     return res;
                 }
             }
             catch (Exception updateEx)
             {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
             }
         }

        public async Task<decimal> SumNav( string exp, Dictionary<string, string> navExp, string field)
        {
            try
            {
                if (string.IsNullOrEmpty(exp) || exp == "None") return 0;
                using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                {
                    dbContext.Database.CommandTimeout = 0;
                    if (!dbContext.FileTypes.Any()) return 0;
                    if (exp == "All" && navExp.Count == 0)
                    {
                        return Convert.ToDecimal(dbContext.FileTypes
										.AsNoTracking()
                                        .Sum(field)??0);
                    }
                    foreach (var itm in navExp)
                    {
                        switch (itm.Key)
                        {
                            case "ApplicationSettings":
                                return await SumWhere<ApplicationSettings>(dbContext, exp, itm.Value, "FileTypes", field, "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeMappings":
                                return await SumWhere<FileTypeMappings>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeActions":
                                return await SumWhere<FileTypeActions>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeContacts":
                                return await SumWhere<FileTypeContacts>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "AsycudaDocumentSet_Attachments":
                                return await SumWhere<AsycudaDocumentSet_Attachments>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileGroups":
                                return await SumWhere<FileGroups>(dbContext, exp, itm.Value, "FileTypes", field, "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "ChildFileTypes":
                                return await SumWhere<FileTypes>(dbContext, exp, itm.Value, "ChildFileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "ParentFileTypes":
                                return await SumWhere<FileTypes>(dbContext, exp, itm.Value, "ChildFileTypes", field, "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "EmailFileTypes":
                                return await SumWhere<EmailFileTypes>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "ImportActions":
                                return await SumWhere<ImportActions>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileTypeReplaceRegex":
                                return await SumWhere<FileTypeReplaceRegex>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "FileImporterInfos":
                                return await SumWhere<FileImporterInfo>(dbContext, exp, itm.Value, "FileTypes", field, "SelectMany")
											.ConfigureAwait(continueOnCapturedContext: false);
                            case "AsycudaDocumentSetAttachments":
                                return await SumWhere<AsycudaDocumentSetAttachments>(dbContext, exp, itm.Value, "FileTypes", field, "Select")
											.ConfigureAwait(continueOnCapturedContext: false);
						}
                    }
                    return Convert.ToDecimal(dbContext.FileTypes.Where(exp == "All" || exp == null ? "Id != null" : exp)
											.AsNoTracking()
                                            .Sum(field)??0);
                }
                
            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                var fault = new ValidationFault
                {
                    Result = false,
                    Message = updateEx.Message,
                    Description = updateEx.StackTrace
                };
                throw new FaultException<ValidationFault>(fault);
            }
        }

		private static async Task<decimal> SumWhere<T>(CoreEntitiesContext dbContext, string exp, string navExp, string navProp, string field, string rel) where T : class
        {
              switch (rel)
		    {
		        case "SelectMany":
                    return await SumWhereSelectMany<T>(dbContext, exp, navExp, navProp, field)
									.ConfigureAwait(continueOnCapturedContext: false);
		        default:
                    return await SumWhereSelect<T>(dbContext, exp, navExp, navProp, field)
									.ConfigureAwait(continueOnCapturedContext: false);
		    }
        }

		private static Task<decimal> SumWhereSelectMany<T>(CoreEntitiesContext dbContext, string exp, string navExp, string navProp, string field) where T : class
        {
			try
			{
            return Task.FromResult(Convert.ToDecimal(dbContext.Set<T>()
                .AsNoTracking()
                .Where(navExp)
                .SelectMany(navProp).OfType<FileTypes>()
                .Where(exp == "All" || exp == null ? "Id != null" : exp)
                .Distinct()
                .OrderBy("Id")
                .Sum(field)));
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }

		private static Task<decimal> SumWhereSelect<T>(CoreEntitiesContext dbContext, string exp, string navExp, string navProp, string field) where T : class
        {
			try
			{
            return Task.FromResult(Convert.ToDecimal(dbContext.Set<T>()
                .AsNoTracking()
                .Where(navExp)
                .Select(navProp).OfType<FileTypes>()
                .Where(exp == "All" || exp == null ? "Id != null" : exp)
                .Distinct()
                .OrderBy("Id")
                .Sum(field)));
			}
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
        }



		 public string MinField(string whereExp, string field)
         {
             try
             {
                 using (var dbContext = new CoreEntitiesContext(){StartTracking = StartTracking})
                 {
                    dbContext.Database.CommandTimeout = 0;
					string res = "";
                     if (string.IsNullOrEmpty(whereExp) || whereExp == "None") return res;
                     if (whereExp == "All")
                     {
                          res = Convert.ToString(dbContext.FileTypes.AsNoTracking().Min(field));
                     }
                     else
                     {
                         res = Convert.ToString(dbContext.FileTypes.AsNoTracking().Where(whereExp).Min(field));
                     }
                     
                     return res;
                 }
             }
             catch (Exception updateEx)
             {
                    System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
             }
         }

		 
		private static IQueryable<FileTypes> AddIncludes(IEnumerable<string> includesLst, CoreEntitiesContext dbContext)
       {
		 try
			{
			   if (includesLst == null) includesLst = new List<string>();
			   var set =(DbQuery<FileTypes>) dbContext.FileTypes; 
			   set = includesLst.Where(x => !string.IsNullOrEmpty(x))
                                .Aggregate(set, (current, itm) => current.Include(itm));
			   return set;
			 }
			catch (Exception)
			{
				Debugger.Break();
				throw;
			}
       }
	   private IQueryable<FileTypes> AddWheres(List<string> expLst, IQueryable<FileTypes> set)
        {
            try
            {
                return expLst.Where(x => !string.IsNullOrEmpty(x))
                             .Aggregate(set, (current, itm) => current.Where(itm));
            }
            catch (Exception)
            {
                Debugger.Break();
                throw;
            }
          
        }

        public void Dispose()
        {
            try
            {
               // var dispose = dbContext as IDisposable;
             ////   if (dispose != null)
            //    {
           //         dbContext.Dispose();
           //     }
            }
            catch (Exception updateEx)
            {
                System.Diagnostics.Debugger.Break();
                //throw new FaultException(updateEx.Message);
                    var fault = new ValidationFault
                                {
                                    Result = false,
                                    Message = updateEx.Message,
                                    Description = updateEx.StackTrace
                                };
                    throw new FaultException<ValidationFault>(fault);
            }

        }

    }
}



